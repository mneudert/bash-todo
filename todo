#!/usr/bin/env bash

TODO_DATE="${TODO_DATE:-%F %T}"
TODO_ROOT="${TODO_ROOT:-$HOME/.todo}"

basedir="${TODO_ROOT}$(pwd)"

basedir_exists() {
  return $([[ -d "${basedir}" ]])
}


#######################################
# Returns the todos for the current working directory.
#
# Returns:
#     Array
#######################################
find_todos() {
    local maxdepth=""

    [ ! -z "${1}" ] && maxdepth="-maxdepth ${1}"

    find "${basedir}" ${maxdepth} -type f
}


#######################################
# Application
#######################################
case "${1}${2}" in
  '') ;&
  help)
    echo 'Usage: todo <command>'
    echo ''
    echo 'All commands are using the current working directory.'
    echo ''
    echo 'Commands:'
    echo '   clear        Clears all todos'
    echo '   count        Returns count of todos'
    echo '   list         Lists all todos'
    echo '   list --raw   Lists all todos in raw format (unsorted, no index, no date)'
    echo '   rm [0-9]*    Deletes a single todo (with index displayed in list)'
    ;;

  clear)
    basedir_exists || { exit 0; }
    find_todos 1 | xargs rm
    ;;

  count)
    basedir_exists || { echo 0; exit 0; }
    find_todos 1 | wc -l
    ;;

  list)
    basedir_exists || { exit 0; }

    todos=($( find_todos 1 | sort -n ))

    todo_num=${#todos[@]}
    pad_len="${#todo_num}"
    pad_str="            "

    for i in "${!todos[@]}"; do
        n=$((1 + $i))

        echo -n "${pad_str:0:$(($pad_len - ${#n}))}${n} | "
        echo -n "$(date -d @$(basename ${todos[$i]}) +"${TODO_DATE}"): "
        cat "${todos[$i]}"
    done
    ;;

  list--raw)
    basedir_exists || { exit 0; }
    find_todos 1 | sort -n | xargs cat
    ;;

  list--recursive)
    basedir_exists || { exit 0; }

    case "${3}" in
        "--raw")
            find_todos
            ;;
        "")
            cur_dir=""
            todos=($( find_todos | sort -n ))

            for todo in "${todos[@]}"; do
                todo_dir=$( dirname "${todo#$TODO_ROOT}" )

                if [[ ${todo_dir} != ${cur_dir} ]]; then
                    [ ! -z "${cur_dir}" ] && echo ""

                    echo "${todo_dir}:"
                    cur_dir=${todo_dir}
                fi

                echo -n "  $(date -d @$(basename ${todo}) +"${TODO_DATE}"): "
                cat "${todo}"
            done
            ;;
    esac
    ;;

  rm[0-9]*)
    basedir_exists || { exit 0; }

    todos=($( find_todos | sort -n ))
    todo=${todos[$(($2 - 1))]}

    [ -f "${todo}" ] && rm "${todo}"
    ;;

  *)
    mkdir -p "${basedir}"
    echo "$@" > "${basedir}/`date +%s`"
    ;;
esac
